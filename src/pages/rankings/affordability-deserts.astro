---
import Base from '../../layouts/Base.astro';
import {
  getAffordabilityDeserts,
  getDesertSummaryByState,
  getNationalDesertStats,
  formatCost,
  getStateName,
} from '../../lib/db';

const db = Astro.locals.runtime.env.DB;

const [deserts, stateSummaries, nationalStats] = await Promise.all([
  getAffordabilityDeserts(db, 100),
  getDesertSummaryByState(db),
  getNationalDesertStats(db),
]);

const title = 'Childcare Affordability Deserts — Where Costs Exceed 20% of Income | PlainChildcare';
const description = `${nationalStats?.desert_count ?? 0} U.S. counties where childcare costs exceed 20% of median income. National average cost burden: ${nationalStats?.avg_cost_burden ?? 0}%.`;

function burdenColor(pct: number): string {
  if (pct > 25) return 'text-amber-600 dark:text-amber-400';
  if (pct > 20) return 'text-amber-500';
  if (pct > 15) return 'text-amber-500';
  return 'text-teal-600 dark:text-teal-400';
}
---

<Base
  title={title}
  description={description}
  breadcrumbs={[
    { name: 'Home', href: '/' },
    { name: 'Rankings', href: '/rankings' },
    { name: 'Affordability Deserts' },
  ]}
>
  <section class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold mb-2">Childcare Affordability Deserts</h1>
    <p class="text-[var(--color-text-secondary)] mb-8">
      Counties where center-based infant care costs exceed 20% of median household income.
      The HHS considers childcare affordable at 7% of income — these counties are nearly 3x that threshold.
    </p>

    <!-- National Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-amber-600 dark:text-amber-400">{nationalStats?.desert_count ?? 0}</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Desert Counties</div>
        <div class="text-xs text-[var(--color-text-secondary)]">of {nationalStats?.total_counties?.toLocaleString()} total</div>
      </div>
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-[var(--color-primary)]">{nationalStats?.avg_cost_burden}%</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Avg Cost Burden</div>
        <div class="text-xs text-[var(--color-text-secondary)]">national average</div>
      </div>
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-amber-600 dark:text-amber-400">{nationalStats?.worst_burden}%</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Worst Burden</div>
      </div>
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-[var(--color-primary)]">7%</div>
        <div class="text-sm text-[var(--color-text-secondary)]">HHS Threshold</div>
        <div class="text-xs text-[var(--color-text-secondary)]">affordable benchmark</div>
      </div>
    </div>

    <!-- Desert Counties Table -->
    <h2 class="text-xl font-semibold mb-4">Counties with Highest Cost Burden</h2>
    <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl overflow-hidden mb-10">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-[var(--color-border)]/30">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-[var(--color-text-secondary)] uppercase">#</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-[var(--color-text-secondary)] uppercase">County</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-[var(--color-text-secondary)] uppercase hidden sm:table-cell">State</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase">Infant Cost</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase hidden md:table-cell">Income</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase">% of Income</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[var(--color-border)]">
            {deserts.map((c, i) => (
              <tr class="hover:bg-[var(--color-surface)] transition-colors">
                <td class="px-4 py-2.5 text-[var(--color-text-secondary)]">{i + 1}</td>
                <td class="px-4 py-2.5">
                  <a href={`/county/${c.slug}`} class="text-[var(--color-primary)] hover:underline font-medium">
                    {c.name}
                  </a>
                </td>
                <td class="px-4 py-2.5 hidden sm:table-cell">{getStateName(c.state)}</td>
                <td class="px-4 py-2.5 text-right tabular-nums">{formatCost(c.center_infant)}</td>
                <td class="px-4 py-2.5 text-right tabular-nums hidden md:table-cell">{formatCost(c.median_income)}</td>
                <td class="px-4 py-2.5 text-right">
                  <span class={`font-semibold ${burdenColor(c.cost_burden_pct)}`}>{c.cost_burden_pct}%</span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- State Summary -->
    <h2 class="text-xl font-semibold mb-4">Cost Burden by State</h2>
    <p class="text-sm text-[var(--color-text-secondary)] mb-4">
      Average childcare cost as a percentage of median income. States with higher burden have more families struggling to afford care.
    </p>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-10">
      {stateSummaries.map(s => (
        <a
          href={`/state/${s.slug}/affordability-deserts`}
          class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 hover:border-[var(--color-primary)] transition-colors"
        >
          <div class="flex justify-between items-start mb-1">
            <span class="font-semibold">{s.name}</span>
            <span class={`text-sm font-semibold ${burdenColor(s.avg_cost_burden)}`}>
              {s.avg_cost_burden}%
            </span>
          </div>
          <div class="text-sm text-[var(--color-text-secondary)]">
            {s.desert_count > 0
              ? <span><strong class="text-amber-600 dark:text-amber-400">{s.desert_count}</strong> desert counties ({s.desert_pct}%)</span>
              : <span class="text-teal-600 dark:text-teal-400">No desert counties</span>
            }
          </div>
          <div class="text-xs text-[var(--color-text-secondary)] mt-1">
            Worst: {s.worst_burden}% · {s.county_count} counties
          </div>
        </a>
      ))}
    </div>

    <!-- Methodology -->
    <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-6 mb-8">
      <h2 class="text-lg font-semibold mb-3">About Affordability Deserts</h2>
      <div class="text-sm text-[var(--color-text-secondary)] space-y-2">
        <p>
          The U.S. Department of Health and Human Services (HHS) defines childcare as "affordable"
          when it costs no more than <strong>7% of a family's income</strong>. In practice, most
          American families spend far more.
        </p>
        <p>
          We flag counties as <strong>"affordability deserts"</strong> when center-based infant care
          exceeds <strong>20% of median household income</strong> — nearly 3x the HHS benchmark.
          These are areas where families face extreme financial pressure to access childcare.
        </p>
        <ul class="list-disc pl-5">
          <li><strong class="text-teal-600 dark:text-teal-400">&lt;10%</strong> — Relatively affordable</li>
          <li><strong class="text-amber-500">10-20%</strong> — Moderate cost burden</li>
          <li><strong class="text-amber-600 dark:text-amber-400">&gt;20%</strong> — Affordability desert</li>
        </ul>
      </div>
    </div>

    <div class="flex gap-4 text-sm mb-6">
      <a href="/rankings" class="text-[var(--color-primary)] hover:underline">&larr; All Rankings</a>
      <a href="/state" class="text-[var(--color-primary)] hover:underline">Browse by State &rarr;</a>
    </div>

    <p class="text-xs text-[var(--color-text-secondary)]">
      Source: U.S. Department of Labor, Women's Bureau — National Database of Childcare Prices (2022).
      Costs are annual center-based infant care. Income is county median household income.
    </p>
  </section>

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://plainchildcare.com/" },
      { "@type": "ListItem", "position": 2, "name": "Rankings", "item": "https://plainchildcare.com/rankings" },
      { "@type": "ListItem", "position": 3, "name": "Affordability Deserts" }
    ]
  })} />
</Base>
