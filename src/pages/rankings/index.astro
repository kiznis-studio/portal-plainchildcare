---
import Base from '../../layouts/Base.astro';
import { getMostExpensiveCounties, getLeastExpensiveCounties, getLeastAffordableCounties, getMostAffordableCounties, formatCost, affordabilityRatio, getStateName } from '../../lib/db';

const db = Astro.locals.runtime.env.DB;
const tab = Astro.url.searchParams.get('tab') || 'expensive';

const mostExpensive = await getMostExpensiveCounties(db, 25);
const leastExpensive = await getLeastExpensiveCounties(db, 25);
const leastAffordable = await getLeastAffordableCounties(db, 25);
const mostAffordable = await getMostAffordableCounties(db, 25);

const tabs = [
  { id: 'expensive', label: 'Most Expensive' },
  { id: 'cheapest', label: 'Least Expensive' },
  { id: 'unaffordable', label: 'Least Affordable' },
  { id: 'affordable', label: 'Most Affordable' },
];

const currentData = tab === 'cheapest' ? leastExpensive
  : tab === 'unaffordable' ? leastAffordable
  : tab === 'affordable' ? mostAffordable
  : mostExpensive;
---

<Base
  title="Childcare Cost Rankings"
  description="Rankings of U.S. counties by childcare cost and affordability. Find the most and least expensive counties for infant, toddler, and preschool care."
  breadcrumbs={[{ name: 'Home', href: '/' }, { name: 'Rankings' }]}
>
  <section class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-2 text-sm text-[var(--color-text-secondary)]">
      <a href="/" class="hover:text-[var(--color-primary)]">Home</a> /
    </div>
    <h1 class="text-2xl md:text-3xl font-bold mb-2">Childcare Cost Rankings</h1>
    <p class="text-[var(--color-text-secondary)] mb-6">Top 25 counties by cost and affordability of center-based infant care</p>

    <div class="flex flex-wrap gap-2 mb-6">
      {tabs.map(t => (
        <a
          href={`/rankings?tab=${t.id}`}
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            tab === t.id
              ? 'bg-[var(--color-primary)] text-white'
              : 'bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text)] hover:border-[var(--color-primary)]'
          }`}
        >{t.label}</a>
      ))}
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-[var(--color-border)] text-left text-[var(--color-text-secondary)]">
            <th class="pb-2 font-medium w-8">#</th>
            <th class="pb-2 font-medium">County</th>
            <th class="pb-2 font-medium hidden sm:table-cell">State</th>
            <th class="pb-2 font-medium text-right">Infant Cost</th>
            <th class="pb-2 font-medium text-right hidden sm:table-cell">Median Income</th>
            <th class="pb-2 font-medium text-right hidden md:table-cell">% of Income</th>
          </tr>
        </thead>
        <tbody>
          {currentData.map((county, i) => (
            <tr class="border-b border-[var(--color-border)] hover:bg-[var(--color-surface)] transition-colors">
              <td class="py-3 text-[var(--color-text-secondary)]">{i + 1}</td>
              <td class="py-3">
                <a href={`/county/${county.slug}`} class="text-[var(--color-primary)] hover:underline font-medium">{county.name}</a>
              </td>
              <td class="py-3 text-[var(--color-text-secondary)] hidden sm:table-cell">{getStateName(county.state)}</td>
              <td class="py-3 text-right font-medium">{formatCost(county.center_infant)}</td>
              <td class="py-3 text-right hidden sm:table-cell">{county.median_income ? '$' + county.median_income.toLocaleString() : 'N/A'}</td>
              <td class="py-3 text-right hidden md:table-cell">{affordabilityRatio(county.center_infant, county.median_income)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <p class="text-xs text-[var(--color-text-secondary)] mt-6">
      Source: U.S. Department of Labor, Women's Bureau â€” National Database of Childcare Prices (NDCP). Affordability = annual infant center cost / median household income.
    </p>
  </section>
</Base>
