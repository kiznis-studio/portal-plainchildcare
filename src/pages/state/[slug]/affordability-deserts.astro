---
import Base from '../../../layouts/Base.astro';
import { getStateBySlug, getAffordabilityDesertsByState, getNationalDesertStats, formatCost, affordabilityRatio } from '../../../lib/db';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const db = Astro.locals.runtime.env.DB;
const state = await getStateBySlug(db, slug);
if (!state) return Astro.redirect('/404');

const [counties, nationalStats] = await Promise.all([
  getAffordabilityDesertsByState(db, state.abbr, 100),
  getNationalDesertStats(db),
]);

if (counties.length === 0) return Astro.redirect(`/state/${slug}`);

const desertCount = counties.filter(c => c.cost_burden_pct > 20).length;
const avgBurden = counties.length > 0
  ? (counties.reduce((sum, c) => sum + c.cost_burden_pct, 0) / counties.length).toFixed(1)
  : '0';
const worstCounty = counties[0];

const title = `Childcare Affordability in ${state.name} — Cost Burden by County | PlainChildcare`;
const description = `Childcare affordability across ${state.name}'s ${counties.length} counties. ${desertCount} counties exceed the 20% cost burden threshold. Average burden: ${avgBurden}%.`;

function burdenColor(pct: number): string {
  if (pct > 25) return 'text-amber-600 dark:text-amber-400';
  if (pct > 20) return 'text-amber-500';
  if (pct > 15) return 'text-amber-500';
  return 'text-teal-600 dark:text-teal-400';
}

function burdenLabel(pct: number): string {
  if (pct > 20) return 'Desert';
  if (pct > 15) return 'High';
  if (pct > 10) return 'Moderate';
  return 'Affordable';
}
---

<Base
  title={title}
  description={description}
  breadcrumbs={[
    { name: 'Home', href: '/' },
    { name: 'States', href: '/state' },
    { name: state.name, href: `/state/${slug}` },
    { name: 'Affordability' },
  ]}
>
  <section class="max-w-6xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold mb-2">Childcare Affordability in {state.name}</h1>
    <p class="text-[var(--color-text-secondary)] mb-8">
      All {counties.length} counties ranked by childcare cost as a percentage of median household income.
      {desertCount > 0
        ? <span><strong class="text-amber-600 dark:text-amber-400">{desertCount}</strong> counties exceed the 20% desert threshold.</span>
        : <span class="text-teal-600 dark:text-teal-400">No counties exceed the 20% desert threshold.</span>
      }
    </p>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class={`text-2xl font-bold ${desertCount > 0 ? 'text-amber-600 dark:text-amber-400' : 'text-teal-600 dark:text-teal-400'}`}>{desertCount}</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Desert Counties</div>
      </div>
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class={`text-2xl font-bold ${burdenColor(Number(avgBurden))}`}>{avgBurden}%</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Avg Cost Burden</div>
        <div class="text-xs text-[var(--color-text-secondary)]">national: {nationalStats?.avg_cost_burden}%</div>
      </div>
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-amber-600 dark:text-amber-400">{worstCounty.cost_burden_pct}%</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Worst Burden</div>
        <div class="text-xs text-[var(--color-text-secondary)]">{worstCounty.name}</div>
      </div>
      <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-[var(--color-primary)]">{counties.length}</div>
        <div class="text-sm text-[var(--color-text-secondary)]">Counties</div>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-[var(--color-surface)] border border-[var(--color-border)] rounded-xl overflow-hidden mb-8">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-[var(--color-border)]/30">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-[var(--color-text-secondary)] uppercase">#</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-[var(--color-text-secondary)] uppercase">County</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase">Infant Cost</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase hidden sm:table-cell">Income</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase">% of Income</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-[var(--color-text-secondary)] uppercase hidden md:table-cell">Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[var(--color-border)]">
            {counties.map((c, i) => (
              <tr class="hover:bg-[var(--color-surface)] transition-colors">
                <td class="px-4 py-2.5 text-[var(--color-text-secondary)]">{i + 1}</td>
                <td class="px-4 py-2.5">
                  <a href={`/county/${c.slug}`} class="text-[var(--color-primary)] hover:underline font-medium">
                    {c.name}
                  </a>
                </td>
                <td class="px-4 py-2.5 text-right tabular-nums">{formatCost(c.center_infant)}</td>
                <td class="px-4 py-2.5 text-right tabular-nums hidden sm:table-cell">{formatCost(c.median_income)}</td>
                <td class="px-4 py-2.5 text-right">
                  <span class={`font-semibold ${burdenColor(c.cost_burden_pct)}`}>{c.cost_burden_pct}%</span>
                </td>
                <td class="px-4 py-2.5 text-right hidden md:table-cell">
                  <span class={`text-xs px-2 py-0.5 rounded-full ${
                    c.cost_burden_pct > 20
                      ? 'bg-amber-500/10 text-amber-600 dark:text-amber-400'
                      : c.cost_burden_pct > 15
                      ? 'bg-amber-500/10 text-amber-500'
                      : 'bg-teal-500/10 text-teal-600 dark:text-teal-400'
                  }`}>
                    {burdenLabel(c.cost_burden_pct)}
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <div class="flex flex-wrap gap-4 text-sm">
      <a href="/rankings/affordability-deserts" class="text-[var(--color-primary)] hover:underline">&larr; National Rankings</a>
      <a href={`/state/${slug}`} class="text-[var(--color-primary)] hover:underline">All {state.name} Counties</a>
      <a href={`/state/${slug}/cheapest-childcare`} class="text-[var(--color-primary)] hover:underline">Cheapest in {state.name}</a>
    </div>

    <p class="text-xs text-[var(--color-text-secondary)] mt-8">
      Source: U.S. Department of Labor, Women's Bureau — National Database of Childcare Prices (2022).
      HHS affordable childcare benchmark: 7% of family income. Desert threshold: 20%+ of median income.
    </p>
  </section>

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://plainchildcare.com/" },
      { "@type": "ListItem", "position": 2, "name": "States", "item": "https://plainchildcare.com/state" },
      { "@type": "ListItem", "position": 3, "name": state.name, "item": `https://plainchildcare.com/state/${slug}` },
      { "@type": "ListItem", "position": 4, "name": "Affordability" }
    ]
  })} />
</Base>
